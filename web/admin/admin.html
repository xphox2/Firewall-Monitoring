<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firewall Monitor - Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0d1117; color: #fff; }

        .sidebar { position: fixed; left: 0; top: 0; width: 250px; height: 100vh; background: #161b22; border-right: 1px solid #30363d; padding: 20px; z-index: 100; }
        .sidebar h2 { color: #00d4ff; font-size: 1.3rem; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #30363d; }
        .nav-item { display: block; padding: 12px 15px; color: #8b949e; text-decoration: none; border-radius: 8px; margin-bottom: 5px; transition: all 0.2s; cursor: pointer; }
        .nav-item:hover, .nav-item.active { background: #21262d; color: #fff; }
        .nav-item.danger { color: #f85149; }

        .main { margin-left: 250px; padding: 30px; min-height: 100vh; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { font-size: 1.8rem; }

        .page { display: none; }
        .page.active { display: block; }

        .card { background: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 25px; margin-bottom: 20px; }
        .card h2 { font-size: 1.2rem; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .card h2 button { background: #238636; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }

        .btn { background: #238636; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        .btn:hover { background: #2ea043; }
        .btn.danger { background: #da3633; }
        .btn.secondary { background: #30363d; }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #30363d; }
        th { color: #8b949e; font-weight: 500; font-size: 0.85rem; }
        tr:hover { background: #21262d; }

        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .status-badge.up, .status-badge.online { background: rgba(63, 185, 80, 0.15); color: #3fb150; }
        .status-badge.down, .status-badge.offline { background: rgba(248, 81, 73, 0.15); color: #f85149; }
        .status-badge.warning { background: rgba(240, 136, 62, 0.15); color: #f0883e; }
        .status-badge.unknown { background: rgba(139, 148, 158, 0.15); color: #8b949e; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #8b949e; font-size: 0.9rem; }
        .form-group input, .form-group select { width: 100%; padding: 10px; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; color: #fff; }

        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 200; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 30px; width: 500px; max-width: 90%; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }

        .connection-diagram { min-height: 400px; position: relative; background: #0d1117; border-radius: 8px; padding: 20px; }
        .node { position: absolute; background: #21262d; border: 2px solid #30363d; border-radius: 8px; padding: 15px; min-width: 150px; text-align: center; cursor: pointer; }
        .node.selected { border-color: #00d4ff; }
        .node .name { font-weight: 600; margin-bottom: 5px; }
        .node .ip { font-size: 0.8rem; color: #8b949e; }
        .node .status { margin-top: 8px; }

        .connection-line { position: absolute; height: 3px; background: #30363d; transform-origin: left center; }
        .connection-line.up { background: #3fb150; }
        .connection-line.down { background: #f85149; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }

        .loading { text-align: center; padding: 30px; color: #8b949e; }
        .error { background: rgba(248, 81, 73, 0.1); border: 1px solid rgba(248, 81, 73, 0.3); color: #f85149; padding: 15px; border-radius: 8px; margin-bottom: 20px; }

        .settings-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .setting-item { background: #0d1117; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .setting-item label { display: block; font-size: 0.85rem; color: #8b949e; margin-bottom: 5px; }
        .setting-item input { width: 100%; padding: 8px; background: #161b22; border: 1px solid #30363d; border-radius: 4px; color: #fff; }

        .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #30363d; }
        .toggle-row:last-child { border-bottom: none; }
        .toggle-row label { color: #c9d1d9; font-size: 0.9rem; }
        .toggle-row input[type="checkbox"] { width: 18px; height: 18px; accent-color: #238636; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>Firewall Monitor</h2>
        <a class="nav-item active" data-page="dashboard">Dashboard</a>
        <a class="nav-item" data-page="devices">Devices</a>
        <a class="nav-item" data-page="connections">Connections</a>
        <a class="nav-item" data-page="settings">Settings</a>
        <a class="nav-item" data-page="alerts">Alerts</a>
        <a class="nav-item" data-page="traps">SNMP Traps</a>
        <a class="nav-item danger" id="logout-btn">Logout</a>
    </div>

    <div class="main">
        <div class="header">
            <h1 id="page-title">Dashboard</h1>
        </div>

        <!-- Dashboard Page -->
        <div class="page active" id="page-dashboard">
            <div class="grid">
                <div class="card">
                    <h3>Total Devices</h3>
                    <div class="value" id="total-devices">--</div>
                </div>
                <div class="card">
                    <h3>Online</h3>
                    <div class="value" id="online-devices">--</div>
                </div>
                <div class="card">
                    <h3>Offline</h3>
                    <div class="value" id="offline-devices">--</div>
                </div>
                <div class="card">
                    <h3>Active Connections</h3>
                    <div class="value" id="active-connections">--</div>
                </div>
            </div>
            <div class="card">
                <h2>Recent Alerts</h2>
                <table id="alerts-table">
                    <thead><tr><th>Time</th><th>Device</th><th>Type</th><th>Severity</th><th>Message</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Devices Page -->
        <div class="page" id="page-devices">
            <div class="card">
                <h2>FortiGate Devices <button class="btn" onclick="showDeviceModal()">+ Add Device</button></h2>
                <table id="devices-table">
                    <thead><tr><th>Name</th><th>IP Address</th><th>Location</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Connections Page -->
        <div class="page" id="page-connections">
            <div class="card">
                <h2>Network Connections <button class="btn" onclick="showConnectionModal()">+ Add Connection</button></h2>
                <p style="color: #8b949e; margin-bottom: 20px;">Map IPSec and VXLAN tunnels between your FortiGate firewalls to visualize tunnel status.</p>
                <table id="connections-table">
                    <thead><tr><th>Name</th><th>Source</th><th>Destination</th><th>Type</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="card">
                <h2>Connection Map</h2>
                <div class="connection-diagram" id="connection-diagram">
                    <div class="loading">Add devices and connections to see the network diagram</div>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div class="page" id="page-settings">
            <div class="card">
                <h2>Admin Password</h2>
                <div class="form-group">
                    <label>Current Password</label>
                    <input type="password" id="current-password">
                </div>
                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" id="new-password">
                </div>
                <div class="form-group">
                    <label>Confirm New Password</label>
                    <input type="password" id="confirm-password">
                </div>
                <button class="btn" onclick="changePassword()">Change Password</button>
            </div>
            <div class="card">
                <h2>Public Dashboard Display</h2>
                <p style="color: #8b949e; margin-bottom: 15px;">Control which cards are visible on the public dashboard.</p>
                <div id="display-settings">
                    <div class="toggle-row">
                        <label>Show Hostname</label>
                        <input type="checkbox" name="public_show_hostname" checked>
                    </div>
                    <div class="toggle-row">
                        <label>Show Uptime</label>
                        <input type="checkbox" name="public_show_uptime" checked>
                    </div>
                    <div class="toggle-row">
                        <label>Show CPU Usage</label>
                        <input type="checkbox" name="public_show_cpu" checked>
                    </div>
                    <div class="toggle-row">
                        <label>Show Memory Usage</label>
                        <input type="checkbox" name="public_show_memory" checked>
                    </div>
                    <div class="toggle-row">
                        <label>Show Active Sessions</label>
                        <input type="checkbox" name="public_show_sessions" checked>
                    </div>
                    <div class="toggle-row">
                        <label>Show Network Interfaces</label>
                        <input type="checkbox" name="public_show_interfaces" checked>
                    </div>
                    <div class="setting-item" style="margin-top: 15px;">
                        <label>Public Dashboard Refresh Interval (seconds)</label>
                        <input type="number" name="public_refresh_interval" value="30" min="10" max="300">
                    </div>
                </div>
            </div>
            <div class="card">
                <h2>Alert Settings</h2>
                <div class="settings-grid" id="settings-alerts"></div>
            </div>
            <div class="card">
                <h2>Notification Settings</h2>
                <div class="settings-grid" id="settings-notifications"></div>
            </div>
            <div class="card">
                <button class="btn" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>

        <!-- Alerts Page -->
        <div class="page" id="page-alerts">
            <div class="card">
                <h2>Alert History</h2>
                <table id="alerts-full-table">
                    <thead><tr><th>Time</th><th>Device</th><th>Type</th><th>Severity</th><th>Message</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Traps Page -->
        <div class="page" id="page-traps">
            <div class="card">
                <h2>SNMP Trap Events</h2>
                <table id="traps-table">
                    <thead><tr><th>Time</th><th>Source IP</th><th>Type</th><th>Severity</th><th>Message</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Device Modal -->
    <div class="modal" id="device-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="device-modal-title">Add FortiGate</h2>
                <span onclick="closeDeviceModal()" style="cursor: pointer; font-size: 1.5rem;">&times;</span>
            </div>
            <form id="device-form">
                <input type="hidden" id="device-id">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="device-name" required>
                </div>
                <div class="form-group">
                    <label>IP Address</label>
                    <input type="text" id="device-ip" required>
                </div>
                <div class="form-group">
                    <label>SNMP Port</label>
                    <input type="number" id="device-snmp-port" value="161">
                </div>
                <div class="form-group">
                    <label>SNMP Community</label>
                    <input type="text" id="device-community" value="public">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="device-location">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="device-description">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn secondary" onclick="testDeviceConnection()">Test Connection</button>
                    <button type="button" class="btn secondary" onclick="closeDeviceModal()">Cancel</button>
                    <button type="submit" class="btn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Connection Modal -->
    <div class="modal" id="connection-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Connection</h2>
                <span onclick="closeConnectionModal()" style="cursor: pointer; font-size: 1.5rem;">&times;</span>
            </div>
            <form id="connection-form">
                <input type="hidden" id="connection-id">
                <div class="form-group">
                    <label>Connection Name</label>
                    <input type="text" id="connection-name" required>
                </div>
                <div class="form-group">
                    <label>Source FortiGate</label>
                    <select id="connection-source" required></select>
                </div>
                <div class="form-group">
                    <label>Destination FortiGate</label>
                    <select id="connection-dest" required></select>
                </div>
                <div class="form-group">
                    <label>Connection Type</label>
                    <select id="connection-type">
                        <option value="ipsec">IPSec</option>
                        <option value="vxlan">VXLAN</option>
                        <option value="ssl">SSL VPN</option>
                        <option value="wan">WAN Link</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <input type="text" id="connection-notes">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn secondary" onclick="closeConnectionModal()">Cancel</button>
                    <button type="submit" class="btn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '/admin/api';
        let currentDevices = [];
        let currentConnections = [];
        let adminRefreshTimer;

        function getCsrfToken() {
            const cookies = document.cookie.split(';');
            for (let c of cookies) {
                const [k, v] = c.trim().split('=');
                if (k === 'csrf_token') return v;
            }
            return '';
        }

        function escapeHtml(str) {
            if (!str) return '';
            const s = String(str);
            return s.replace(/[&<>"']/g, c => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            })[c]);
        }

        async function apiFetch(url, options = {}) {
            try {
                const res = await fetch(url, {
                    ...options,
                    headers: {
                        'X-CSRF-Token': getCsrfToken(),
                        ...options.headers
                    }
                });
                if (res.status === 401 || res.status === 302) {
                    window.location.href = '/admin/login';
                    return null;
                }
                if (!res.ok) {
                    const err = await res.json().catch(() => ({ error: 'Request failed' }));
                    throw new Error(err.error || 'Request failed');
                }
                return await res.json();
            } catch (e) {
                if (e.message === 'Failed to fetch') {
                    console.error('Network error - server may be down');
                }
                throw e;
            }
        }

        document.querySelectorAll('.nav-item[data-page]').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById('page-' + item.dataset.page).classList.add('active');
                document.getElementById('page-title').textContent = item.textContent;
                loadPageData(item.dataset.page);
            });
        });

        async function loadPageData(page) {
            switch(page) {
                case 'dashboard': await loadDashboard(); break;
                case 'devices': await loadDevices(); break;
                case 'connections': await loadConnections(); break;
                case 'settings': await loadSettings(); break;
                case 'alerts': await loadAlerts(); break;
                case 'traps': await loadTraps(); break;
            }
        }

        async function loadDashboard() {
            try {
                const result = await apiFetch(`${API_BASE}/dashboard`);
                if (!result) return;
                const data = result.data;

                document.getElementById('total-devices').textContent = data.fortigates?.length || 0;
                document.getElementById('online-devices').textContent = data.fortigates?.filter(f => f.status === 'online').length || 0;
                document.getElementById('offline-devices').textContent = data.fortigates?.filter(f => f.status === 'offline').length || 0;
                document.getElementById('active-connections').textContent = data.connections?.filter(c => c.status === 'up').length || 0;

                const tbody = document.querySelector('#alerts-table tbody');
                tbody.innerHTML = data.recent_alerts?.map(a => `
                    <tr>
                        <td>${new Date(a.timestamp).toLocaleString()}</td>
                        <td>FG-${a.fortigate_id}</td>
                        <td>${escapeHtml(a.alert_type)}</td>
                        <td><span class="status-badge ${escapeHtml(a.severity)}">${escapeHtml(a.severity).toUpperCase()}</span></td>
                        <td>${escapeHtml(a.message)}</td>
                    </tr>
                `).join('') || '<tr><td colspan="5" class="loading">No alerts</td></tr>';
            } catch (e) {
                console.error('Failed to load dashboard:', e);
            }
        }

        async function loadDevices() {
            try {
                const result = await apiFetch(`${API_BASE}/fortigates`);
                if (!result) return;
                currentDevices = result.data || [];

                const tbody = document.querySelector('#devices-table tbody');
                tbody.innerHTML = currentDevices.map(d => `
                    <tr>
                        <td>${escapeHtml(d.name)}</td>
                        <td>${escapeHtml(d.ip_address)}</td>
                        <td>${escapeHtml(d.location) || '-'}</td>
                        <td><span class="status-badge ${escapeHtml(d.status)}">${escapeHtml(d.status).toUpperCase()}</span></td>
                        <td>
                            <button class="btn secondary" onclick="editDevice(${d.id})">Edit</button>
                            <button class="btn danger" onclick="deleteDevice(${d.id})">Delete</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="5" class="loading">No devices configured</td></tr>';
            } catch (e) {
                console.error('Failed to load devices:', e);
            }
        }

        async function loadConnections() {
            try {
                const [devicesResult, connsResult] = await Promise.all([
                    apiFetch(`${API_BASE}/fortigates`),
                    apiFetch(`${API_BASE}/connections`)
                ]);
                if (!devicesResult || !connsResult) return;
                currentDevices = devicesResult.data || [];
                currentConnections = connsResult.data || [];

                const tbody = document.querySelector('#connections-table tbody');
                tbody.innerHTML = currentConnections.map(c => `
                    <tr>
                        <td>${escapeHtml(c.name)}</td>
                        <td>${escapeHtml(c.source_fg?.name) || c.source_fg_id}</td>
                        <td>${escapeHtml(c.dest_fg?.name) || c.dest_fg_id}</td>
                        <td>${escapeHtml(c.connection_type?.toUpperCase()) || 'IPSEC'}</td>
                        <td><span class="status-badge ${escapeHtml(c.status)}">${escapeHtml(c.status).toUpperCase()}</span></td>
                        <td>
                            <button class="btn danger" onclick="deleteConnection(${c.id})">Delete</button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="6" class="loading">No connections configured</td></tr>';

                drawConnectionDiagram();
                populateDeviceSelects();
            } catch (e) {
                console.error('Failed to load connections:', e);
            }
        }

        function drawConnectionDiagram() {
            const container = document.getElementById('connection-diagram');
            if (currentDevices.length === 0) {
                container.innerHTML = '<div class="loading">Add devices to see the network diagram</div>';
                return;
            }

            const containerRect = container.getBoundingClientRect();
            const centerX = containerRect.width / 2;
            const centerY = containerRect.height / 2;
            const radius = Math.min(centerX, centerY) - 80;

            container.innerHTML = '';

            currentDevices.forEach((device, i) => {
                const angle = (2 * Math.PI * i) / currentDevices.length - Math.PI / 2;
                const x = centerX + radius * Math.cos(angle) - 75;
                const y = centerY + radius * Math.sin(angle) - 30;

                const node = document.createElement('div');
                node.className = 'node';
                node.style.left = x + 'px';
                node.style.top = y + 'px';
                node.innerHTML = `
                    <div class="name">${escapeHtml(device.name)}</div>
                    <div class="ip">${escapeHtml(device.ip_address)}</div>
                    <div class="status"><span class="status-badge ${escapeHtml(device.status)}">${escapeHtml(device.status)}</span></div>
                `;
                container.appendChild(node);
            });

            currentConnections.forEach(conn => {
                const sourceIdx = currentDevices.findIndex(d => d.id === conn.source_fg_id);
                const destIdx = currentDevices.findIndex(d => d.id === conn.dest_fg_id);

                if (sourceIdx >= 0 && destIdx >= 0) {
                    const srcAngle = (2 * Math.PI * sourceIdx) / currentDevices.length - Math.PI / 2;
                    const dstAngle = (2 * Math.PI * destIdx) / currentDevices.length - Math.PI / 2;

                    const x1 = centerX + radius * Math.cos(srcAngle);
                    const y1 = centerY + radius * Math.sin(srcAngle);
                    const x2 = centerX + radius * Math.cos(dstAngle);
                    const y2 = centerY + radius * Math.sin(dstAngle);

                    const line = document.createElement('div');
                    line.className = `connection-line ${conn.status}`;

                    const length = Math.sqrt((x2-x1)**2 + (y2-y1)**2);
                    const angle = Math.atan2(y2-y1, x2-x1) * 180 / Math.PI;

                    line.style.width = length + 'px';
                    line.style.left = x1 + 'px';
                    line.style.top = y1 + 'px';
                    line.style.transform = `rotate(${angle}deg)`;

                    container.appendChild(line);
                }
            });
        }

        async function loadSettings() {
            try {
                const result = await apiFetch(`${API_BASE}/settings`);
                if (!result) return;
                const settings = result.data || [];

                const alertSettings = settings.filter(s => s.category === 'alerts');
                const notifSettings = settings.filter(s => s.category === 'notifications');

                document.getElementById('settings-alerts').innerHTML = [
                    { key: 'cpu_threshold', label: 'CPU Threshold (%)', value: 80, type: 'number' },
                    { key: 'memory_threshold', label: 'Memory Threshold (%)', value: 80, type: 'number' },
                    { key: 'disk_threshold', label: 'Disk Threshold (%)', value: 90, type: 'number' },
                    { key: 'session_threshold', label: 'Session Threshold', value: 100000, type: 'number' }
                ].map(s => `
                    <div class="setting-item">
                        <label>${s.label}</label>
                        <input type="${s.type}" name="${s.key}" value="${alertSettings.find(x => x.key === s.key)?.value || s.value}">
                    </div>
                `).join('');

                document.getElementById('settings-notifications').innerHTML = [
                    { key: 'email_enabled', label: 'Enable Email', type: 'checkbox' },
                    { key: 'slack_webhook', label: 'Slack Webhook URL', type: 'text' },
                    { key: 'discord_webhook', label: 'Discord Webhook URL', type: 'text' }
                ].map(s => {
                    const savedVal = notifSettings.find(x => x.key === s.key)?.value || '';
                    if (s.type === 'checkbox') {
                        const checked = savedVal === 'true' ? 'checked' : '';
                        return `<div class="setting-item"><label>${s.label}</label><input type="checkbox" name="${s.key}" ${checked}></div>`;
                    }
                    return `<div class="setting-item"><label>${s.label}</label><input type="text" name="${s.key}" value="${savedVal}"></div>`;
                }).join('');

                // Load display settings
                const displayResult = await apiFetch(`${API_BASE}/display-settings`);
                if (displayResult && displayResult.data) {
                    const ds = displayResult.data;
                    document.querySelectorAll('#display-settings input[type="checkbox"]').forEach(cb => {
                        cb.checked = ds[cb.name] !== 'false';
                    });
                    const refreshInput = document.querySelector('#display-settings input[name="public_refresh_interval"]');
                    if (refreshInput && ds['public_refresh_interval']) {
                        refreshInput.value = ds['public_refresh_interval'];
                    }
                }
            } catch (e) {
                console.error('Failed to load settings:', e);
            }
        }

        async function loadAlerts() {
            try {
                const result = await apiFetch(`${API_BASE}/alerts`);
                if (!result) return;
                const alerts = result.data || [];

                document.querySelector('#alerts-full-table tbody').innerHTML = alerts.map(a => `
                    <tr>
                        <td>${new Date(a.timestamp).toLocaleString()}</td>
                        <td>FG-${a.fortigate_id}</td>
                        <td>${escapeHtml(a.alert_type)}</td>
                        <td><span class="status-badge ${escapeHtml(a.severity)}">${escapeHtml(a.severity).toUpperCase()}</span></td>
                        <td>${escapeHtml(a.message)}</td>
                    </tr>
                `).join('') || '<tr><td colspan="5" class="loading">No alerts</td></tr>';
            } catch (e) {
                console.error('Failed to load alerts:', e);
            }
        }

        async function loadTraps() {
            try {
                const result = await apiFetch(`${API_BASE}/traps`);
                if (!result) return;
                const traps = result.data || [];

                document.querySelector('#traps-table tbody').innerHTML = traps.map(t => `
                    <tr>
                        <td>${new Date(t.timestamp).toLocaleString()}</td>
                        <td>${escapeHtml(t.source_ip)}</td>
                        <td>${escapeHtml(t.trap_type)}</td>
                        <td><span class="status-badge ${escapeHtml(t.severity)}">${escapeHtml(t.severity).toUpperCase()}</span></td>
                        <td>${escapeHtml(t.message)}</td>
                    </tr>
                `).join('') || '<tr><td colspan="5" class="loading">No traps</td></tr>';
            } catch (e) {
                console.error('Failed to load traps:', e);
            }
        }

        function showDeviceModal(id = null) {
            document.getElementById('device-modal').classList.add('active');
            document.getElementById('device-modal-title').textContent = id ? 'Edit FortiGate' : 'Add FortiGate';

            if (id) {
                const device = currentDevices.find(d => d.id === id);
                document.getElementById('device-id').value = device.id;
                document.getElementById('device-name').value = device.name;
                document.getElementById('device-ip').value = device.ip_address;
                document.getElementById('device-snmp-port').value = device.snmp_port || 161;
                document.getElementById('device-community').value = device.snmp_community || 'public';
                document.getElementById('device-location').value = device.location || '';
                document.getElementById('device-description').value = device.description || '';
            } else {
                document.getElementById('device-form').reset();
                document.getElementById('device-id').value = '';
            }
        }

        function closeDeviceModal() {
            document.getElementById('device-modal').classList.remove('active');
        }

        async function testDeviceConnection() {
            const ip = document.getElementById('device-ip').value;
            const port = document.getElementById('device-snmp-port').value || 161;
            const community = document.getElementById('device-community').value || 'public';

            if (!ip) {
                alert('Please enter an IP address first');
                return;
            }

            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'Testing...';
            btn.disabled = true;

            try {
                const result = await apiFetch(`${API_BASE}/fortigates/test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ip_address: ip,
                        snmp_port: parseInt(port),
                        snmp_community: community,
                        snmp_version: '2c'
                    })
                });

                if (result && result.data?.online) {
                    alert(`Connection Successful!\n\nHostname: ${result.data.hostname}\nVersion: ${result.data.version}\nCPU: ${result.data.cpu}%\nMemory: ${result.data.memory}%`);
                } else {
                    alert(`Connection Failed\n\n${result?.data?.message || 'Unknown error'}`);
                }
            } catch (err) {
                alert(`Error: ${err.message}`);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        document.getElementById('device-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('device-id').value;
            const data = {
                name: document.getElementById('device-name').value,
                ip_address: document.getElementById('device-ip').value,
                snmp_port: parseInt(document.getElementById('device-snmp-port').value),
                snmp_community: document.getElementById('device-community').value,
                location: document.getElementById('device-location').value,
                description: document.getElementById('device-description').value,
                enabled: true
            };

            try {
                const method = id ? 'PUT' : 'POST';
                const url = id ? `${API_BASE}/fortigates/${id}` : `${API_BASE}/fortigates`;
                await apiFetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
                closeDeviceModal();
                loadDevices();
            } catch (err) {
                alert('Error saving device: ' + err.message);
            }
        });

        async function editDevice(id) { showDeviceModal(id); }

        async function deleteDevice(id) {
            if (!confirm('Delete this FortiGate?')) return;
            try {
                await apiFetch(`${API_BASE}/fortigates/${id}`, { method: 'DELETE' });
                loadDevices();
            } catch (err) {
                alert('Error deleting device: ' + err.message);
            }
        }

        function populateDeviceSelects() {
            const selects = ['connection-source', 'connection-dest'];
            selects.forEach(sid => {
                const sel = document.getElementById(sid);
                sel.innerHTML = currentDevices.map(d => `<option value="${d.id}">${escapeHtml(d.name)} (${escapeHtml(d.ip_address)})</option>`).join('');
            });
        }

        function showConnectionModal() {
            if (currentDevices.length < 2) {
                alert('You need at least 2 devices to create a connection');
                return;
            }
            document.getElementById('connection-modal').classList.add('active');
            document.getElementById('connection-form').reset();
            populateDeviceSelects();
        }

        function closeConnectionModal() {
            document.getElementById('connection-modal').classList.remove('active');
        }

        document.getElementById('connection-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('connection-name').value,
                source_fg_id: parseInt(document.getElementById('connection-source').value),
                dest_fg_id: parseInt(document.getElementById('connection-dest').value),
                connection_type: document.getElementById('connection-type').value,
                notes: document.getElementById('connection-notes').value
            };

            try {
                await apiFetch(`${API_BASE}/connections`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                closeConnectionModal();
                loadConnections();
            } catch (err) {
                alert('Error creating connection: ' + err.message);
            }
        });

        async function deleteConnection(id) {
            if (!confirm('Delete this connection?')) return;
            try {
                await apiFetch(`${API_BASE}/connections/${id}`, { method: 'DELETE' });
                loadConnections();
            } catch (err) {
                alert('Error deleting connection: ' + err.message);
            }
        }

        async function changePassword() {
            const current = document.getElementById('current-password').value;
            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-password').value;

            if (!current || !newPass || !confirmPass) {
                alert('Please fill in all password fields');
                return;
            }

            if (newPass !== confirmPass) {
                alert('New passwords do not match');
                return;
            }

            if (newPass.length < 8) {
                alert('Password must be at least 8 characters');
                return;
            }

            try {
                const result = await apiFetch(`${API_BASE}/settings/password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        current_password: current,
                        new_password: newPass
                    })
                });

                if (result && result.success) {
                    alert(result.message);
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';
                } else {
                    alert('Error: ' + (result?.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function saveSettings() {
            const settings = [];

            // Alert and notification settings
            document.querySelectorAll('#settings-alerts input, #settings-notifications input').forEach(input => {
                const value = input.type === 'checkbox' ? String(input.checked) : input.value;
                settings.push({
                    key: input.name,
                    value: value,
                    category: ['email_enabled','slack_webhook','discord_webhook'].includes(input.name) ? 'notifications' : 'alerts',
                    type: input.type === 'checkbox' ? 'bool' : 'string'
                });
            });

            // Public display settings
            document.querySelectorAll('#display-settings input').forEach(input => {
                const value = input.type === 'checkbox' ? String(input.checked) : input.value;
                settings.push({
                    key: input.name,
                    value: value,
                    category: 'display',
                    type: input.type === 'checkbox' ? 'bool' : 'string'
                });
            });

            try {
                await apiFetch(`${API_BASE}/settings`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                });
                alert('Settings saved!');
            } catch (err) {
                alert('Error saving settings: ' + err.message);
            }
        }

        document.getElementById('logout-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            await fetch('/api/auth/logout', { method: 'POST' });
            window.location.href = '/';
        });

        // Initial load
        loadDashboard();

        // Auto-refresh dashboard every 30s
        adminRefreshTimer = setInterval(() => {
            const activePage = document.querySelector('.page.active');
            if (activePage && activePage.id === 'page-dashboard') {
                loadDashboard();
            }
        }, 30000);
    </script>
</body>
</html>
